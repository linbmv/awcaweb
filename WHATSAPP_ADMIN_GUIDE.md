# WhatsApp 管理功能使用指南

## 概述

本指南将帮助您使用新增的 WhatsApp 管理功能，实现以下核心功能：

1. **扫码登录** - 通过网页界面扫码连接 WhatsApp
2. **联系人管理** - 查看和管理 WhatsApp 联系人列表
3. **用户关联** - 将读经用户与 WhatsApp 联系人关联
4. **智能推送** - 发送统计信息时真实@用户而非文本

## 功能特性

### ✨ 核心功能

- **🖥️ 网页扫码登录** - 无需命令行，直接在网页上扫码登录 WhatsApp
- **👥 联系人同步** - 自动获取并显示 WhatsApp 联系人列表
- **🔗 智能关联** - 简单点击即可将读经用户与 WhatsApp 联系人关联
- **📱 真实@推送** - 发送统计信息时真正@用户，提供更好的通知体验
- **🔄 实时状态** - 显示连接状态、QR码和操作反馈

### 📋 管理功能

- **连接管理** - 查看连接状态，支持断开和重新连接
- **群组选择** - 选择发送统计信息的目标群组
- **关联管理** - 查看所有用户关联状态，支持修改和取消关联
- **测试发送** - 一键发送测试统计信息验证功能

## 使用步骤

### 第一步：访问管理页面

1. 打开读经管理系统
2. 输入应用密码登录
3. 点击右上角的 **"WhatsApp"** 按钮进入管理页面

### 第二步：连接 WhatsApp

1. 在管理页面中，您会看到连接状态卡片
2. 如果显示"未连接"，点击 **"重新连接"** 按钮
3. 系统会生成二维码
4. 使用手机 WhatsApp 扫描二维码
5. 连接成功后，状态会显示为"已连接"

### 第三步：管理联系人关联

1. 在 **"用户关联管理"** 部分，您可以看到所有读经用户
2. 对于未关联的用户，点击 **"关联联系人"** 按钮
3. 在弹出的联系人列表中选择对应的 WhatsApp 联系人
4. 关联成功后，用户卡片会显示已关联状态

### 第四步：选择目标群组

1. 在 **"可用群组"** 部分，查看所有可用的 WhatsApp 群组
2. 点击选择要发送统计信息的群组
3. 被选中的群组会有高亮显示

### 第五步：测试发送

1. 在 **"测试发送"** 部分，点击 **"发送测试统计"** 按钮
2. 系统会生成并发送一条测试统计信息到选定群组
3. 检查 WhatsApp 群组是否收到消息

### 第六步：返回主页面

1. 点击页面顶部的 **"← 返回"** 按钮
2. 回到主页面正常使用系统

## API 接口说明

### WhatsApp 管理 API

#### 获取连接状态
```bash
GET /api/whatsapp-admin?action=status
```

响应示例：
```json
{
  "isReady": true,
  "state": "connected",
  "hasQr": false,
  "qrTimestamp": null,
  "authExists": true
}
```

#### 获取 QR 码
```bash
GET /api/whatsapp-admin?action=qr
```

#### 获取联系人列表
```bash
GET /api/whatsapp-admin?action=contacts
```

#### 获取群组列表
```bash
GET /api/whatsapp-admin?action=groups
```

#### 重新连接
```bash
POST /api/whatsapp-admin
{
  "action": "connect"
}
```

#### 断开连接
```bash
POST /api/whatsapp-admin
{
  "action": "disconnect"
}
```

#### 清除认证
```bash
POST /api/whatsapp-admin
{
  "action": "clear_auth"
}
```

### 用户关联 API

#### 获取用户关联信息
```bash
GET /api/user-association
```

#### 关联用户
```bash
POST /api/user-association
{
  "userId": "用户ID",
  "contactJid": "联系人JID"
}
```

#### 取消关联
```bash
DELETE /api/user-association?userId=用户ID
```

### 发送统计信息 API

#### 发送统计（支持WhatsApp格式）
```bash
POST /api/send-statistics
{
  "channel": "whatsapp_api",
  "useWhatsAppFormat": true
}
```

## 数据存储

### 关联数据存储位置
- **本地开发环境**: `data/whatsapp-associations.json`
- **生产环境**: 取决于后端存储配置

### 关联数据格式
```json
{
  "userToContact": {
    "用户ID": "联系人JID"
  },
  "contactToUser": {
    "联系人JID": "用户ID"
  }
}
```

## 故障排除

### 问题 1：无法获取 QR 码

**症状**: 连接状态显示"等待扫码"，但没有显示 QR 码

**解决方案**:
1. 检查 WhatsApp 服务是否已启动
2. 查看浏览器控制台是否有错误信息
3. 刷新页面重试

### 问题 2：扫码后连接失败

**症状**: 扫描 QR 码后，连接状态没有变为"已连接"

**解决方案**:
1. 确认手机网络连接正常
2. 重新生成 QR 码（刷新页面）
3. 重新扫描 QR 码
4. 检查认证文件是否存在

### 问题 3：联系人列表为空

**症状**: 连接成功，但无法获取联系人列表

**解决方案**:
1. 确认 WhatsApp 账号已正常登录
2. 等待几秒钟让联系人同步完成
3. 刷新页面重试

### 问题 4：无法关联用户

**症状**: 点击"关联联系人"后没有反应

**解决方案**:
1. 检查网络连接
2. 查看浏览器控制台错误
3. 刷新页面重试
4. 确认联系人未被其他用户关联

### 问题 5：测试发送失败

**症状**: 点击"发送测试统计"后显示错误

**解决方案**:
1. 确认已选择目标群组
2. 检查 WhatsApp 连接状态
3. 查看后端日志获取详细错误信息
4. 确认群组 JID 格式正确

## 注意事项

### 安全注意事项

1. **认证文件保护**
   - WhatsApp 认证文件存储在 `whatsapp_auth` 目录
   - 请勿将认证文件提交到版本控制系统
   - 部署时确保认证文件的安全性

2. **敏感信息**
   - WhatsApp 群组 JID 和联系人信息包含敏感数据
   - 请妥善保管，避免泄露

### 使用注意事项

1. **连接稳定性**
   - WhatsApp 连接可能会意外断开
   - 系统会自动尝试重连
   - 如长时间无法重连，需要重新扫码

2. **关联唯一性**
   - 一个联系人只能关联到一个读经用户
   - 如需修改关联，需要先取消现有关联

3. **群组权限**
   - 确保 bot 账号有目标群组的发送权限
   - 被踢出的群组将无法接收消息

## 技术实现

### 核心技术栈

- **后端**: Node.js + Express + Baileys
- **前端**: Vue 3 + Composition API
- **WhatsApp 库**: Baileys (WhatsApp Web API)
- **数据存储**: JSON 文件（本地）/数据库（生产）

### 架构设计

```
┌─────────────────┐
│   前端界面      │
│  (Vue 3)       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   Express API   │
│                 │
├─────────────────┤
│ WhatsApp Admin  │ ────► Baileys SDK
│ User Association│ ────► JSON Storage
│ Send Statistics │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ WhatsApp Web    │
│                 │
└─────────────────┘
```

## 更新日志

### v1.0.0 (2025-10-28)

- ✅ 新增 WhatsApp 管理页面
- ✅ 实现扫码登录功能
- ✅ 实现联系人同步
- ✅ 实现用户关联管理
- ✅ 实现智能@推送
- ✅ 新增相关 API 接口
- ✅ 添加详细使用文档

## 支持与反馈

如果您在使用过程中遇到问题或有改进建议，请通过以下方式联系：

- 提交 GitHub Issue
- 发送邮件反馈
- 查看项目文档获取更多信息

---

**注意**: 本功能基于 Baileys 库实现，仅用于学习和个人使用。使用前请确保遵守 WhatsApp 的服务条款和相关法律法规。
